# Intro

The purpose of this repo is to show **How to capture application logs when using Amazon EKS on AWS Fargate**. It takes inspiration from the following blogpost
https://aws.amazon.com/blogs/containers/how-to-capture-application-logs-when-using-amazon-eks-on-aws-fargate/

# Kubernetes Logging Structure and issues with Fargate



# Demo Cluster

The demo container produces logs to _/var/log/containers/application.log._ Fluentd is configured to watch /var/log/containers and send log events to CloudWatch. The pod also runs a logrotate sidecar container that ensures the container logs donâ€™t deplete the disk space. In the example, cron triggers logrotate every 15 minutes; you can customize the logrotate behavior using environment variables.


**Create Cluster**

The command below will create an EKS cluster. All pods in kube-system and default namespaces will run on Fargate. There will be no EC2 nodes in this cluster.

```eksctl create cluster \
--name eksfargate-logging-demo \
--fargate
```

Create a new namespace that will run the demo application.

`kubectl create namespace logdemo`

Create a new Fargate profile for logdemo namespace. This tells EKS to run the pods in logdemo namespace on Fargate.

```eksctl create fargateprofile \
--namespace logdemo --cluster \
eksfargate-logging-demo \
--name logdemo
```

Create an IAM OIDC identity provider for the cluster.

```eksctl utils associate-iam-oidc-provider \
--cluster=eksfargate-logging-demo \
--approve
```

Create an IAM role and a Kubernetes service account for Fluentd. This role permits Fluentd container to write log events to CloudWatch.

```eksctl create iamserviceaccount \
--name logdemo-sa \
--namespace logdemo \
--cluster eksfargate-logging-demo \
--attach-policy-arn arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy  \
--approve
```

You can review the service account created in the previous step.

```
$ kubectl get serviceaccount -n logdemo
NAME         SECRETS   AGE
default      1         50m
logdemo-sa   1         1m
```

**Create a manifest for Fluentd ClusterRole,RoleBinding, and ConfigMap.**

`kubectl apply -f k8s/fluentd_rbac.yaml`

**Deploy the sample application with the command**

`kubectl apply -f k8s/application_deployment.yaml`

You can see the written logs using the AWS CLI or CloudWatch console. Using AWS CLI:

```aws logs get-log-events \
--log-group-name "/aws/containerinsights/eksfargate-logging-demo/springapp" \
--log-stream-name "springlogs"\
```

You should see log events generated by the demo container:

```{
            "timestamp": 1605107746717,
            "message": "{\"message\":\"Time: Wed Nov 11 15:15:46 UTC 2020 KGCqO9kHlpgHmMjHHz4EfYhl9mobZgFPwVK1sst9g4t21xr8ijnTBRZlic4J0I50Pw97PJB17MaT2WeiOav4F2TazC8h3ncGz5VLltBshiOdpMLRLB8WlScpeITypxObvJ8Gs2sjvkiPMYyqFAjzoFGstsbiUbOoaJETBvcTiIpZgvQRu1IeYIYG9j56m8CQonO89uYpiUeTvrOemR8gE5BdpJ3ys6XgQDYzAoRPoFwIx7ZmFXNvfqTC4sArviFVIpKkGiz698vv03dEIV2ueGa7d3KlU7178lPieR5MMIvVzNPZSx9BnJ0yozu0aIhanJ50m2Vh71KljBF2d0V7EAulm4JtaCxSUMUJDEAyK8kDmXzafLuol0JkA9etqcaePgmvSOi5D4OILeFl0HBHL5kVfyjJQ0QQftkDtWK0BJp3prB2vX2yMBgvFadz2U1RgrkOMvQO48uRznLAv3kmVufIMZAFDca7rOMYCtT3dSgqnqwGtZmtbF58zXe5BsFRhvrHqHsKwmeQaKEI721uobjJfhK5neXnRRUBZZIrbwn7vuHSPm5xvVPtwsxLXUXRHcM6xhS2O4DEc7sZ1AZv4PYOMlL3w1Ojo7bK9mJZw9r8qiNL7HBRPBl79HGYW2OJN7venowKYYcYiYha25dUBMTRY1yXZFN1goyY2cIjwsq2TarJZyxTqkMHjHCfI4AOomGjRpRg6IoEkPgq0net0Z0OC4mLIv2G1On82uOsEeqpW9Z2XW6ROKhXYKcgIwsSpfq3O9XTKBrs7OQVYl4TNPdn5aIDDDYzTtvrfw0pC5kbpgQrdFGShReNvL9IMYqp3GKDAiJtIeRwAlMZIK7u2RlC8NkkzWCFZwqQAFiU7YZP7UUjLfDvMXCtjfazQsEI7SC7IXpIToP4EvWY9plpUv9jcuv2mSIGEuviqYYbDqu1UMkvyBL9UsFCX6coD6MUFsnIFJq1RIEBmUuJmadnWbwTC1TBNS3AQ8dlkh3amXo5BKiNeTUzyeDUA9kLy0FR\"}",
            "ingestionTime": 1605107749742
        }
```

# Next - AWS for Fluent Bit

**Log Destoinations**

* Kinesis Data Firehose
* Cloudwatch  Logs
* Kafka
* Self-hosted ElasticSearch


# References

* [Building a scalable log solution aggregator with AWS Fargate, Fluentd, and Amazon Kinesis Data Firehose](https://aws.amazon.com/blogs/compute/building-a-scalable-log-solution-aggregator-with-aws-fargate-fluentd-and-amazon-kinesis-data-firehose/)
* [aws/containers-roadmap](https://github.com/aws/containers-roadmap/issues/10)
* [AWS Container Logging Deep Dive: FireLens, Fluentd, and Fluent Bit - AWS Online Tech Talks](https://www.youtube.com/watch?v=HaT9Yc1g170)
* [aws-for-fluent-bit](https://github.com/aws/aws-for-fluent-bit)



